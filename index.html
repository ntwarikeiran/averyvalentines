<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>For Avery üíñ</title>

<style>
:root{
  --accent:#E96A6A;   /* soft red accent */
  --accent2:#F7A6C6;  /* blush */
  --bgA:#F7C1CC;      /* blush pink */
  --bgB:#D6C6F5;      /* lavender */
  --bgC:#FFD6C9;      /* peach */
  --panel: rgba(255,255,255,.72);
  --ink:#2a2526;      /* slightly warmer ink */
  --shadow:0 25px 60px rgba(233,106,106,.14);
  --r:28px;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  min-height:100vh;
  display:grid;
  place-items:center;
  color: var(--ink);
  transition: background 400ms ease, color 250ms ease;

  /* room for florals */
  padding: clamp(18px, 4vw, 46px);

  background:
    radial-gradient(1000px 600px at 20% 10%, color-mix(in srgb, var(--accent2) 18%, white) 0%, transparent 55%),
    radial-gradient(900px 500px at 90% 20%, color-mix(in srgb, var(--bgC) 22%, white) 0%, transparent 50%),
    linear-gradient(135deg, var(--bgA), var(--bgB), var(--bgC));
}

/* ===== Themes per stage ===== */
body[data-theme="welcome"]{
  --bgA:#FFF6FA; --bgB:#EDE2FF; --bgC:#FFE4DA; --accent:#E96A6A; --accent2:#F7A6C6;
  --panel: rgba(255,255,255,.80); --ink:#2a2526;
}
body[data-theme="love-letter"]{
  --bgA:#FFF2F7; --bgB:#EDE2FF; --bgC:#FFE1D6; --accent:#E96A6A; --accent2:#F7A6C6;
  --panel: rgba(255,255,255,.74); --ink:#2a2526;
}
body[data-theme="pop-quiz"]{
  --bgA:#F9F3FF; --bgB:#EDE2FF; --bgC:#FFE4DA; --accent:#E96A6A; --accent2:#F7A6C6;
  --panel: rgba(255,255,255,.76); --ink:#2a2526;
}
body[data-theme="arcade"]{
  --bgA:#1A0F2E; --bgB:#2A1447; --bgC:#3A1B52; --accent:#F7A6C6; --accent2:#D6C6F5;
  --panel: rgba(255,255,255,.10); --ink:#F8FAFC;
}
body[data-theme="polaroid"]{
  --bgA:#FFF6FA; --bgB:#FFE9F2; --bgC:#FFE4DA; --accent:#E96A6A; --accent2:#F7A6C6;
  --panel: rgba(255,255,255,.80); --ink:#2a2526;
}

/* Ensure background reacts to theme vars */
body{
  background:
    radial-gradient(1000px 600px at 20% 10%, color-mix(in srgb, var(--accent2) 18%, white) 0%, transparent 55%),
    radial-gradient(900px 500px at 90% 20%, color-mix(in srgb, var(--bgC) 22%, white) 0%, transparent 50%),
    linear-gradient(135deg, var(--bgA), var(--bgB), var(--bgC));
}

/* =========================
   Watercolor floral frame
   (uses floral.jpg)
========================= */
.floralFrame{
  position: fixed;
  inset: 10px;
  pointer-events: none;
  z-index: 0;
  opacity: 0.55;
  background-image: url("floral.jpg");
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
  filter: saturate(1.05) blur(0.15px);
}

body[data-theme="arcade"] .floralFrame{
  opacity: 0.14;
  filter: saturate(1) blur(0.2px);
}

@media (max-width: 520px){
  .floralFrame{
    inset: 6px;
    opacity: 0.42;
  }
}

.wrap{
  width:min(1040px,92vw);
  display:grid;
  gap:18px;
  grid-template-columns:1.15fr .85fr;
  align-items:start;
  position:relative;
  z-index:1; /* above frame */
}
@media(max-width:920px){.wrap{grid-template-columns:1fr}}

.card{
  background:
    linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.70));
  backdrop-filter:blur(10px);
  border-radius:30px;
  padding:24px;
  box-shadow:0 25px 60px rgba(233,106,106,.12);
  border:1px solid rgba(255,255,255,.78);
}
body[data-theme="arcade"] .card{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.18);
}

h1{margin:0 0 6px; font-size:clamp(26px,4vw,36px)}
h2{margin:0 0 10px; font-size:clamp(18px,3vw,24px)}
p{margin:8px 0; line-height:1.4}

.pillrow{display:flex;gap:10px;flex-wrap:wrap; margin:10px 0 12px}
.pill{
  padding:6px 12px;
  border-radius:999px;
  background: color-mix(in srgb, var(--accent) 12%, white);
  font-size:13px;
  border:1px solid color-mix(in srgb, var(--accent) 18%, transparent);
}
.small{font-size:13px; opacity:.78}

.bigbtn{
  border:0;
  padding:12px 16px;
  border-radius:16px;
  font-weight:800;
  cursor:pointer;
  transition:transform .12s ease, box-shadow 260ms ease, filter 260ms ease;
}
.bigbtn:active{transform:translateY(1px) scale(.99)}
.bigbtn.primary:hover{
  box-shadow: 0 18px 45px rgba(233,106,106,.22);
  transform: translateY(-1px);
}
.bigbtn.ghost:hover{ transform: translateY(-1px); }

.primary{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff;
  box-shadow:0 12px 25px rgba(0,0,0,.12);
}
.ghost{
  background:rgba(255,255,255,.85);
  border:1px solid rgba(0,0,0,.08);
  color: var(--ink);
}
body[data-theme="arcade"] .ghost{
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.22);
}

.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

.lockedBadge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  background:rgba(0,0,0,.08);
  font-size:13px;
  width:max-content;
}
body[data-theme="arcade"] .lockedBadge{ background: rgba(255,255,255,.12); }

/* Stage nav */
.stageNav{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin:10px 0 14px;
}
.step{
  font-size:13px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.65);
}
body[data-theme="arcade"] .step{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
.step.done{
  border-color: rgba(40,167,69,.25);
  background: rgba(40,167,69,.10);
}
.step.active{
  border-color: color-mix(in srgb, var(--accent) 35%, transparent);
  background: color-mix(in srgb, var(--accent) 10%, white);
}

/* Stage enter animation */
.stageScene{ animation: sceneIn 520ms cubic-bezier(.22,.61,.36,1) both; }
@keyframes sceneIn{
  from{ opacity:0; transform: translateY(8px); }
  to{ opacity:1; transform: translateY(0); }
}

/* ===== Welcome page ===== */
.welcomeHero{
  display:grid;
  gap:14px;
  align-items:center;
  text-align:center;
  padding: 10px 6px 2px;
}
.plushFrame{
  width:min(320px, 80vw);
  margin: 0 auto;
  padding:14px;
  border-radius:22px;
  background: rgba(255,255,255,.55);
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 18px 35px rgba(0,0,0,.12);
}
.plushImg{
  width: 100%;
  height: auto;
  display:block;
  border-radius:18px;
  animation: plushBob 2.6s ease-in-out infinite;
}
@keyframes plushBob{
  0%,100%{ transform: translateY(0px) rotate(-1deg); }
  50%{ transform: translateY(-8px) rotate(1deg); }
}

/* ===== Crossword ===== */
.cwGrid{display:flex; flex-direction:column; gap:10px; margin-top:10px}
.cwRow{ display:flex; gap:10px; transition:.2s; }
.cwRow.correct .cell{
  background: color-mix(in srgb, var(--accent) 15%, white);
  border-color: color-mix(in srgb, var(--accent) 40%, transparent);
}
.cwRow.correct{ animation: pop .22s ease }
@keyframes pop{ 0%{transform:scale(1)} 50%{transform:scale(1.03)} 100%{transform:scale(1)} }
.cell{
  width:52px;
  height:56px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.10);
  background:rgba(255,255,255,.85);
  display:grid;
  place-items:center;
  position:relative;
  box-shadow:0 10px 18px rgba(0,0,0,.08);
}
body[data-theme="arcade"] .cell{ background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.18); }
.cell input{
  width:100%;
  height:100%;
  border:0;
  background:none;
  text-align:center;
  font-size:22px;
  font-weight:900;
  text-transform:uppercase;
  outline:none;
  border-radius:14px;
  color: var(--ink);
}
.cell input:focus{ box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent); }
.number{
  position:absolute;
  top:5px;
  left:7px;
  font-size:11px;
  opacity:.6;
  font-weight:900;
}
.clues{margin-top:10px; font-size:14px}
.clue{display:flex; gap:10px; padding:5px 0; border-top:1px solid rgba(0,0,0,.06)}
.clue:first-child{border-top:0}
.clue b{min-width:18px}
body[data-theme="arcade"] .clue{ border-top-color: rgba(255,255,255,.12); }

/* ===== Quiz (Canvas-style) ===== */
.quizBox{
  background:rgba(255,255,255,.65);
  border:1px solid rgba(0,0,0,.08);
  border-radius:18px;
  padding:14px;

  display:flex;
  flex-direction:column;
  gap:16px;

  position: relative; /* for submitting overlay */
}
body[data-theme="arcade"] .quizBox{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.18);
}

.q{
  padding: 16px;
  border-radius: 16px;
  background: rgba(255,255,255,.85);
  border: 1px solid rgba(0,0,0,.08);
}
body[data-theme="arcade"] .q{
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.18);
}

.qtitle{
  font-weight: 900;
  margin-bottom: 12px;
}

.choices{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.choice{
  width:100%;
  text-align:left;
  padding:10px 14px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.10);
  background:#fff;
  cursor:pointer;
  font-weight:800;
  color:#111;
}
body[data-theme="arcade"] .choice{
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.20);
  color: var(--ink);
}
.choice.correct{border-color: rgba(40,167,69,.35); background: rgba(40,167,69,.10)}
.choice.wrong{border-color: color-mix(in srgb, var(--accent) 35%, transparent); background: color-mix(in srgb, var(--accent) 10%, white); }

/* Canvas-style quiz info bar */
.quizInfo{
  margin-top: 14px;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,.75);
  border: 1px solid rgba(0,0,0,.08);
  color: rgba(0,0,0,.65);
}
body[data-theme="arcade"] .quizInfo{
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.18);
  color: rgba(255,255,255,.75);
}

/* Submitting overlay (Canvas-ish) */
.submittingOverlay{
  position:absolute;
  inset:0;
  border-radius:18px;
  background: rgba(255,255,255,.78);
  backdrop-filter: blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  font-weight:900;
  z-index:5;
}
body[data-theme="arcade"] .submittingOverlay{
  background: rgba(20,20,24,.55);
}

/* little spinner */
.spinner{
  width:18px;
  height:18px;
  border-radius:999px;
  border:3px solid rgba(0,0,0,.12);
  border-top-color: color-mix(in srgb, var(--accent) 70%, transparent);
  animation: spin .8s linear infinite;
}
body[data-theme="arcade"] .spinner{
  border-color: rgba(255,255,255,.18);
  border-top-color: rgba(255,255,255,.55);
}
@keyframes spin{ to{ transform: rotate(360deg); } }

/* ===== Heart Catch ===== */
.arena{
  position:relative;
  height:280px;
  border-radius:18px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.65);
  overflow:hidden;
}
body[data-theme="arcade"] .arena{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
.hud{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin:10px 0 8px;
  font-weight:800;
}
.falling{
  position:absolute;
  top:-30px;
  user-select:none;
  cursor:pointer;
  filter: drop-shadow(0 8px 10px rgba(0,0,0,.15));
  animation: fall linear forwards;
}
@keyframes fall{
  to{ transform: translateY(340px) rotate(360deg); opacity: 0.95; }
}

/* ===== Slide Puzzle ===== */
.puzzleWrap{ display:flex; flex-direction:column; gap:10px; }
.puzzleMeta{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-weight:800;
}
.puzzleBoard{
  width: 300px;
  height: 300px;
  border-radius:18px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.65);
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap:8px;
  padding:8px;
  overflow:hidden;
}
@media(max-width:420px){
  .puzzleBoard{ width: 270px; height: 270px; }
}
.tileBtn{
  border:1px solid rgba(0,0,0,.10);
  border-radius:14px;
  background:#fff;
  cursor:pointer;
  box-shadow:0 10px 18px rgba(0,0,0,.08);
  background-repeat:no-repeat;
  background-size: 300% 300%;
  transition: transform .08s ease;
}
.tileBtn:active{ transform: translateY(1px) scale(.99); }
.tileBtn.blank{
  background:none;
  border:1px dashed rgba(0,0,0,.12);
  box-shadow:none;
  cursor:default;
}

/* Right panel */
.final{
  margin-top:14px;
  padding:18px;
  border-radius:18px;
  border:1px dashed color-mix(in srgb, var(--accent) 40%, transparent);
  background: color-mix(in srgb, var(--accent) 10%, white);
}
.btnrow{display:flex;gap:12px;position:relative;min-height:60px}
#maybeBtn{position:relative}

/* Toast + confetti hearts */
.toast{
  position:fixed;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  background:#000c;
  color:#fff;
  padding:10px 14px;
  border-radius:999px;
  opacity:0;
  transition:.2s;
  pointer-events:none;
  font-weight:700;
  z-index: 10;
}
.toast.show{opacity:1}
.confetti{
  position:fixed;
  top:-20px;
  animation: fallConf linear forwards;
  pointer-events:none;
  z-index: 9;
}
@keyframes fallConf{
  to{transform:translateY(110vh) rotate(360deg); opacity:0}
}

/* ===== Ambient floating hearts ===== */
.ambientHeart{
  position: fixed;
  bottom: -30px;
  pointer-events: none;
  opacity: .18;
  filter: blur(.2px);
  z-index: 1; /* above floral frame, behind cards */
  animation: driftUp linear forwards;
}
@keyframes driftUp{
  from{ transform: translateY(0) translateX(0) scale(.9); opacity: 0; }
  15%{ opacity: .18; }
  to{ transform: translateY(-110vh) translateX(40px) scale(1.15); opacity: 0; }
}
</style>
</head>

<body data-theme="welcome">
  <div class="floralFrame"></div>

  <div class="wrap">

    <!-- LEFT -->
    <section class="card">
      <h1>Hey Avery üíñ</h1>
      <p>Little quest time. Beat the games to unlock my question üò≥</p>

      <div class="pillrow">
        <span class="pill">About us ü´∂</span>
        <span class="pill">Cute + interactive</span>
        <span class="pill">Unlock the surprise üíå</span>
      </div>

      <div class="stageNav" id="stageNav"></div>

      <!-- Stage 0: Welcome -->
      <div id="stage0" class="stageScene">
        <div class="welcomeHero">
          <div class="plushFrame">
            <img class="plushImg" src="jellycat.png" alt="A cute plush friend" />
          </div>

          <h2 style="margin:0">Welcome, Avery üíñ</h2>
          <p style="margin:0; opacity:.88">
            I made you a tiny quest. Beat the games to unlock a question I‚Äôve been saving üò≥
          </p>

          <div class="row" style="justify-content:center; margin-top:10px">
            <button class="bigbtn primary" id="startQuestBtn">Start the quest üíå</button>
          </div>

          <p class="small" style="margin:0">
            If the plush image doesn‚Äôt show: make sure <b>jellycat.png</b> is next to <b>index.html</b>.
          </p>
        </div>
      </div>

      <!-- Stage 1: Crossword -->
      <div id="stage1" class="stageScene" style="display:none">
        <h2>Game 1: Crossword</h2>
        <p class="small">Rows turn pink when correct.</p>
        <div class="cwGrid" id="cwGrid"></div>
        <div class="clues" id="clues"></div>

        <div class="row" style="margin-top:12px">
          <button class="bigbtn primary" id="cwCheckBtn">Check</button>
          <button class="bigbtn ghost" id="cwClearBtn">Clear</button>
        </div>
      </div>

      <!-- Stage 2: Quiz -->
      <div id="stage2" class="stageScene" style="display:none">
        <h2>Game 2: Mini Quiz</h2>
        <p class="small">Pick the right answers üòå</p>

        <div class="quizBox" id="quizBox"></div>

        <div class="quizInfo">
          <span>Attempt 1 of 1</span>
          <span>3 questions ‚Ä¢ 3 points</span>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="bigbtn primary" id="quizSubmitBtn">Submit</button>
          <button class="bigbtn ghost" id="quizResetBtn">Clear Answers</button>
        </div>
      </div>

      <!-- Stage 3: Heart Catch -->
      <div id="stage3" class="stageScene" style="display:none">
        <h2>Game 3: Heart Catch</h2>
        <p class="small">Click hearts before they fall. Reach the goal to win.</p>
        <div class="hud">
          <div>Score: <span id="score">0</span>/<span id="goal">10</span></div>
          <div>Time: <span id="time">15</span>s</div>
        </div>
        <div class="arena" id="arena" aria-label="Heart catch arena"></div>
        <div class="row" style="margin-top:12px">
          <button class="bigbtn primary" id="startCatchBtn">Start</button>
          <button class="bigbtn ghost" id="resetCatchBtn">Reset</button>
        </div>
      </div>

      <!-- Stage 4: Slide Puzzle -->
      <div id="stage4" class="stageScene" style="display:none">
        <h2>Game 4: Slide Puzzle</h2>
        <p class="small">Slide the tiles to rebuild our photo ü´∂</p>

        <div class="puzzleWrap">
          <div class="puzzleMeta">
            <div>Moves: <span id="moves">0</span></div>
            <div>Status: <span id="puzzleStatus">Not started</span></div>
          </div>

          <div class="puzzleBoard" id="puzzleBoard" aria-label="Slide puzzle board"></div>

          <div class="row" style="margin-top:12px">
            <button class="bigbtn primary" id="shufflePuzzleBtn">Shuffle</button>
            <button class="bigbtn ghost" id="resetPuzzleBtn">Reset</button>
          </div>
        </div>

        <p class="small">Put a photo named <b>photo.jpg</b> next to <b>index.html</b>.</p>
      </div>

      <p class="small" style="margin-top:14px">
        Tip: You can customize quiz questions & heart goal inside the code near ‚ÄúCUSTOMIZE‚Äù.
      </p>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="lockedBadge" id="lockBadge">üîí Locked ‚Äî beat all games</div>

      <div class="final" id="finalBox">
        <h2>A question for you‚Ä¶</h2>
        <p id="finalBody">It‚Äôs locked until you finish the quest üíå</p>

        <div class="btnrow" id="btnRow">
          <button class="bigbtn primary" id="yesBtn" disabled>YES üíò</button>
          <button class="bigbtn ghost" id="maybeBtn" disabled>maybe üôà</button>
        </div>
      </div>

      <div class="final" id="successBox" style="display:none">
        <h2 id="successHeader">AVERY SAID YES üò≠üíñ</h2>
        <p id="successBody">Okay wow. Best day ever. ü•∞ I can‚Äôt wait to be your Valentine.</p>
        <button class="bigbtn primary" id="restartAllBtn">Play again</button>
      </div>
    </section>

  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CUSTOMIZE
========================= */
const CROSSWORD = [
  { clue: "Our favorite date spot", answer: "Carrollton" },
  { clue: "Our favorite song",      answer: "The Dress" },
  { clue: "Our favorite trip",      answer: "New York" }
];

const QUIZ = [
  {
    q: "Where did we have our first date?",
    choices: ["Panera Bread", "Chili's", "Olive Garden", "In-N-Out"],
    correctIndex: 0
  },
  {
    q: "What was our first trip together?",
    choices: ["Austin", "Corpus Christi", "New York", "Boston"],
    correctIndex: 0
  },
  {
    q: "What do I love most about you?",
    choices: [
      "All of the above",
      "Your sweet smile",
      "Your caring nature",
      "Your unstoppable work ethic",
      "Your amazing sense of humor"
    ],
    correctIndex: 0
  }
];

const CATCH_GOAL = 10;
const CATCH_TIME = 15;

// Images must be next to index.html
const PUZZLE_IMG = "photo.jpg";
const WELCOME_IMG = "jellycat.png"; // referenced in HTML

const FINAL_QUESTION = "Avery‚Ä¶ will you be my Valentine? üíå";
const AFTER_YES_TITLE = "AVERY SAID YES üò≠üíñ";
const AFTER_YES_BODY  = "Okay wow. Best day ever. ü•∞ I can‚Äôt wait to be your Valentine.";

/* =========================
   HELPERS
========================= */
const normalize = s => (s||"").toUpperCase().replace(/[^A-Z0-9]/g,"");
const toast = document.getElementById("toast");
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1200);
}
function confettiHearts(count=28){
  const hearts = ["üíñ","üíò","üíù","üíó","üíï","üíû"];
  for(let i=0;i<count;i++){
    const el = document.createElement("div");
    el.className = "confetti";
    el.textContent = hearts[Math.floor(Math.random()*hearts.length)];
    el.style.left = Math.random()*100 + "vw";
    el.style.fontSize = (14+Math.random()*18) + "px";
    el.style.animationDuration = (2.2+Math.random()*2.6) + "s";
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 5200);
  }
}

/* Quiz submitting helpers */
const quizBox = document.getElementById("quizBox");
const quizSubmitBtn = document.getElementById("quizSubmitBtn");
const quizResetBtn = document.getElementById("quizResetBtn");

function setQuizControlsDisabled(disabled){
  quizSubmitBtn.disabled = disabled;
  quizResetBtn.disabled = disabled;

  quizBox.querySelectorAll(".choice").forEach(btn=>{
    btn.disabled = disabled;
    btn.style.pointerEvents = disabled ? "none" : "auto";
    btn.style.opacity = disabled ? 0.85 : 1;
  });
}

function showSubmittingOverlay(){
  const overlay = document.createElement("div");
  overlay.className = "submittingOverlay";
  overlay.innerHTML = `<div class="spinner"></div><div>Submitting‚Ä¶</div>`;
  overlay.id = "submittingOverlay";
  quizBox.appendChild(overlay);
}

function hideSubmittingOverlay(){
  document.getElementById("submittingOverlay")?.remove();
}

/* =========================
   STAGES + THEMES
========================= */
const stageNav = document.getElementById("stageNav");
const stageEls = [
  document.getElementById("stage0"),
  document.getElementById("stage1"),
  document.getElementById("stage2"),
  document.getElementById("stage3"),
  document.getElementById("stage4")
];

const themes = ["welcome", "love-letter", "pop-quiz", "arcade", "polaroid"];

let stage = 0; // 0..4
let stageDone = [false,false,false,false]; // games 1..4

function renderStageNav(){
  stageNav.innerHTML = "";
  const labels = ["0) Welcome", "1) Crossword", "2) Quiz", "3) Heart Catch", "4) Slide Puzzle"];

  labels.forEach((lab, i)=>{
    const step = document.createElement("div");
    const done = (i === 0) ? false : stageDone[i-1];
    step.className = "step" + (done ? " done" : "") + (stage===i ? " active" : "");
    step.textContent = lab;
    stageNav.appendChild(step);
  });
}

function goToStage(i){
  stage = i;
  stageEls.forEach((el, idx)=> el.style.display = (idx===stage ? "block" : "none"));
  document.body.setAttribute("data-theme", themes[i] || "welcome");
  renderStageNav();
}

function markStageDone(gameIndex){
  stageDone[gameIndex] = true;
  renderStageNav();

  const stageIndex = gameIndex + 1;
  if (gameIndex < stageDone.length - 1){
    goToStage(stageIndex + 1);
  } else {
    unlockFinalIfAllDone();
  }
}

/* =========================
   WELCOME
========================= */
document.getElementById("startQuestBtn").onclick = () => goToStage(1);

/* =========================
   GAME 1: CROSSWORD
========================= */
const cwGrid = document.getElementById("cwGrid");
const clues = document.getElementById("clues");
const cwCheckBtn = document.getElementById("cwCheckBtn");
const cwClearBtn = document.getElementById("cwClearBtn");
let cwRows = [];

function buildCrossword(){
  cwGrid.innerHTML = "";
  clues.innerHTML = "";
  cwRows = [];

  CROSSWORD.forEach((q, ri)=>{
    const rowEl = document.createElement("div");
    rowEl.className = "cwRow";
    const answer = normalize(q.answer);
    const inputs = [];

    for(let i=0;i<answer.length;i++){
      const cell = document.createElement("div");
      cell.className = "cell";
      if(i===0){
        const n = document.createElement("div");
        n.className = "number";
        n.textContent = ri+1;
        cell.appendChild(n);
      }
      const inp = document.createElement("input");
      inp.maxLength = 1;

      inp.addEventListener("input", ()=>{
        inp.value = inp.value.toUpperCase().replace(/[^A-Z0-9]/g,"");
        if(inp.value && i < inputs.length-1) inputs[i+1].focus();
        updateCrosswordRow(ri);
      });

      inp.addEventListener("keydown", (e)=>{
        if(e.key==="Backspace" && !inp.value && i>0) inputs[i-1].focus();
        setTimeout(()=>updateCrosswordRow(ri), 0);
        if(e.key==="Enter") checkCrosswordAll();
      });

      cell.appendChild(inp);
      rowEl.appendChild(cell);
      inputs.push(inp);
    }

    cwGrid.appendChild(rowEl);
    cwRows.push({rowEl, inputs, answer, ok:false});

    const c = document.createElement("div");
    c.className = "clue";
    c.innerHTML = `<b>${ri+1}.</b><div>${q.clue}</div>`;
    clues.appendChild(c);
  });

  cwRows[0]?.inputs[0]?.focus();
}

function rowGuess(r){
  return normalize(r.inputs.map(x=>x.value).join(""));
}

function updateCrosswordRow(i){
  const r = cwRows[i];
  const guess = rowGuess(r);
  const correct = guess.length === r.answer.length && guess === r.answer;

  if(correct && !r.ok){
    r.ok = true;
    r.rowEl.classList.add("correct");
    showToast(`Clue ${i+1} ‚úîÔ∏è`);
  }
  if(!correct && r.ok){
    r.ok = false;
    r.rowEl.classList.remove("correct");
  }
  if(cwRows.every(x=>x.ok)){
    cwRows.forEach(x=>x.inputs.forEach(inp=>inp.disabled=true));
    confettiHearts(18);
    markStageDone(0);
  }
}

function checkCrosswordAll(){
  cwRows.forEach((_,i)=>updateCrosswordRow(i));
  if(!cwRows.every(x=>x.ok)) showToast("Almost‚Ä¶ try again üíó");
}
function clearCrossword(){
  cwRows.forEach(r=>{
    r.inputs.forEach(i=>i.value="");
    r.ok=false;
    r.rowEl.classList.remove("correct");
  });
  cwRows[0]?.inputs[0]?.focus();
}

cwCheckBtn.onclick = checkCrosswordAll;
cwClearBtn.onclick = clearCrossword;

/* =========================
   GAME 2: QUIZ
========================= */
let quizState = [];

function buildQuiz(){
  hideSubmittingOverlay();
  quizBox.innerHTML = "";
  quizState = Array(QUIZ.length).fill(null);

  QUIZ.forEach((item, qi)=>{
    const qDiv = document.createElement("div");
    qDiv.className = "q";

    const title = document.createElement("div");
    title.className = "qtitle";
    title.textContent = `${qi+1}. ${item.q}`;
    qDiv.appendChild(title);

    const choices = document.createElement("div");
    choices.className = "choices";

    item.choices.forEach((txt, ci)=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.type = "button";
      b.textContent = txt;

      b.onclick = ()=>{
        [...choices.children].forEach(ch=>{
          ch.classList.remove("correct","wrong");
          ch.style.outline = "none";
        });
        quizState[qi] = ci;
        b.style.outline = "3px solid rgba(233,106,106,.22)";
      };

      choices.appendChild(b);
    });

    qDiv.appendChild(choices);
    quizBox.appendChild(qDiv);
  });
}

function gradeQuiz(){
  if(quizState.some(v=>v===null)){
    showToast("Answer all of them üòå");
    return;
  }

  setQuizControlsDisabled(true);
  showSubmittingOverlay();

  const delay = 800;

  setTimeout(()=>{
    hideSubmittingOverlay();

    let allCorrect = true;
    [...quizBox.querySelectorAll(".q")].forEach((qEl, qi)=>{
      const item = QUIZ[qi];
      const chosen = quizState[qi];
      const choiceBtns = [...qEl.querySelectorAll(".choice")];

      choiceBtns.forEach((btn, ci)=>{
        btn.classList.remove("correct","wrong");
        if(ci === item.correctIndex) btn.classList.add("correct");
        if(ci === chosen && chosen !== item.correctIndex) btn.classList.add("wrong");
      });

      if(chosen !== item.correctIndex) allCorrect = false;
    });

    setQuizControlsDisabled(false);

    if(allCorrect){
      showToast("Perfect üò≠üíñ");
      confettiHearts(18);
      markStageDone(1);
    } else {
      showToast("Close‚Ä¶ try again üíó");
    }
  }, delay);
}

quizSubmitBtn.onclick = gradeQuiz;
quizResetBtn.onclick = ()=>{ buildQuiz(); showToast("Cleared ‚ú®"); };

/* =========================
   GAME 3: HEART CATCH
========================= */
const arena = document.getElementById("arena");
const scoreEl = document.getElementById("score");
const goalEl = document.getElementById("goal");
const timeEl = document.getElementById("time");
const startCatchBtn = document.getElementById("startCatchBtn");
const resetCatchBtn = document.getElementById("resetCatchBtn");

goalEl.textContent = String(CATCH_GOAL);

let catchScore = 0;
let catchTime = CATCH_TIME;
let catchTimer = null;
let spawnTimer = null;
let running = false;

function setCatchHUD(){
  scoreEl.textContent = String(catchScore);
  timeEl.textContent = String(catchTime);
}

function spawnHeart(){
  const hearts = ["üíñ","üíò","üíù","üíó","üíï","üíû"];
  const h = document.createElement("div");
  h.className = "falling";
  h.textContent = hearts[Math.floor(Math.random()*hearts.length)];

  const x = Math.random() * (arena.clientWidth - 30);
  h.style.left = `${x}px`;
  h.style.fontSize = `${18 + Math.random()*18}px`;
  h.style.animationDuration = `${1.8 + Math.random()*1.6}s`;

  h.onclick = ()=>{
    if(!running) return;
    catchScore += 1;
    setCatchHUD();
    h.remove();
    if(catchScore >= CATCH_GOAL) winCatch();
  };

  h.addEventListener("animationend", ()=> h.remove());
  arena.appendChild(h);
}

function startCatch(){
  if(running) return;
  running = true;
  catchScore = 0;
  catchTime = CATCH_TIME;
  arena.innerHTML = "";
  setCatchHUD();
  showToast("Go go go! üíñ");

  catchTimer = setInterval(()=>{
    catchTime -= 1;
    setCatchHUD();
    if(catchTime <= 0) endCatch(false);
  }, 1000);

  spawnTimer = setInterval(spawnHeart, 450);
}

function endCatch(won){
  running = false;
  clearInterval(catchTimer);
  clearInterval(spawnTimer);
  catchTimer = null;
  spawnTimer = null;
  if(!won) showToast("So close! Try again üíó");
}

function winCatch(){
  endCatch(true);
  showToast("You did it üò≠üíñ");
  confettiHearts(22);
  markStageDone(2);
}

function resetCatch(){
  endCatch(false);
  arena.innerHTML = "";
  catchScore = 0;
  catchTime = CATCH_TIME;
  setCatchHUD();
  showToast("Reset ‚ú®");
}

startCatchBtn.onclick = startCatch;
resetCatchBtn.onclick = resetCatch;

/* =========================
   GAME 4: SLIDE PUZZLE (3x3)
========================= */
const puzzleBoard = document.getElementById("puzzleBoard");
const shufflePuzzleBtn = document.getElementById("shufflePuzzleBtn");
const resetPuzzleBtn = document.getElementById("resetPuzzleBtn");
const movesEl = document.getElementById("moves");
const puzzleStatusEl = document.getElementById("puzzleStatus");

let puzzle = [];
let moves = 0;

function setMoves(n){ moves = n; movesEl.textContent = String(moves); }
function setPuzzleStatus(t){ puzzleStatusEl.textContent = t; }

function solvedPuzzle(){
  for(let i=0;i<9;i++) if(puzzle[i] !== i) return false;
  return true;
}
function idxOfBlank(){ return puzzle.indexOf(8); }
function neighbors(idx){
  const res = [];
  const r = Math.floor(idx/3), c = idx%3;
  if(r>0) res.push(idx-3);
  if(r<2) res.push(idx+3);
  if(c>0) res.push(idx-1);
  if(c<2) res.push(idx+1);
  return res;
}
function canMove(tileIdx){
  const b = idxOfBlank();
  return neighbors(b).includes(tileIdx);
}
function swap(i,j){
  const t = puzzle[i];
  puzzle[i] = puzzle[j];
  puzzle[j] = t;
}

function renderPuzzle(){
  puzzleBoard.innerHTML = "";
  for(let pos=0; pos<9; pos++){
    const tile = puzzle[pos];
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "tileBtn";

    if(tile === 8){
      btn.classList.add("blank");
      btn.disabled = true;
    } else {
      const tileR = Math.floor(tile/3);
      const tileC = tile%3;
      btn.style.backgroundImage = `url('${PUZZLE_IMG}')`;
      btn.style.backgroundPosition = `${tileC * 50}% ${tileR * 50}%`;

      btn.onclick = ()=>{
        if(!canMove(pos)) return;
        const b = idxOfBlank();
        swap(pos, b);
        setMoves(moves + 1);
        renderPuzzle();

        if(solvedPuzzle()){
          setPuzzleStatus("Solved ‚úÖ");
          confettiHearts(28);
          showToast("Photo restored üò≠üíñ");
          [...puzzleBoard.querySelectorAll("button")].forEach(x=>x.disabled=true);
          markStageDone(3);
        }
      };
    }
    puzzleBoard.appendChild(btn);
  }
}

function resetPuzzle(){
  puzzle = [0,1,2,3,4,5,6,7,8];
  setMoves(0);
  setPuzzleStatus("Not started");
  renderPuzzle();
}

function isSolvable(arr){
  let inv = 0;
  const a = arr.filter(x=>x!==8);
  for(let i=0;i<a.length;i++){
    for(let j=i+1;j<a.length;j++){
      if(a[i] > a[j]) inv++;
    }
  }
  return inv % 2 === 0;
}

function shufflePuzzle(){
  let arr;
  do {
    arr = [...Array(9).keys()];
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  } while(!isSolvable(arr) || arr.every((v,i)=>v===i));

  puzzle = arr;
  setMoves(0);
  setPuzzleStatus("Shuffled üé≤");
  renderPuzzle();
}

shufflePuzzleBtn.onclick = shufflePuzzle;
resetPuzzleBtn.onclick = resetPuzzle;

/* =========================
   FINAL UNLOCK
========================= */
const lockBadge = document.getElementById("lockBadge");
const finalBody = document.getElementById("finalBody");
const yesBtn = document.getElementById("yesBtn");
const maybeBtn = document.getElementById("maybeBtn");
const btnRow = document.getElementById("btnRow");
const finalBox = document.getElementById("finalBox");
const successBox = document.getElementById("successBox");
const successHeader = document.getElementById("successHeader");
const successBody = document.getElementById("successBody");
const restartAllBtn = document.getElementById("restartAllBtn");

function unlockFinalIfAllDone(){
  if(!stageDone.every(Boolean)) return;

  lockBadge.textContent = "üîì Unlocked ‚Äî you beat the quest ü´∂";
  lockBadge.style.background = "rgba(40,167,69,.12)";
  lockBadge.style.border = "1px solid rgba(40,167,69,.25)";
  finalBody.textContent = FINAL_QUESTION;
  yesBtn.disabled = false;
  maybeBtn.disabled = false;
  confettiHearts(32);
}

yesBtn.onclick = ()=>{
  finalBox.style.display = "none";
  successBox.style.display = "block";
  successHeader.textContent = AFTER_YES_TITLE;
  successBody.textContent = AFTER_YES_BODY;
  confettiHearts(45);
};

maybeBtn.onmouseenter = maybeBtn.onclick = ()=>{
  if(maybeBtn.disabled) return;
  const r = btnRow.getBoundingClientRect();
  const maxX = Math.max(0, r.width - 100);
  const maxY = Math.max(0, r.height - 45);
  maybeBtn.style.position = "absolute";
  maybeBtn.style.left = Math.random() * maxX + "px";
  maybeBtn.style.top  = Math.random() * maxY + "px";
  showToast("Averyyyy üòº");
};

restartAllBtn.onclick = ()=>{
  stageDone = [false,false,false,false];
  resetFinalUI();
  buildCrossword();
  buildQuiz();
  resetCatch();
  resetPuzzle();
  goToStage(0);
};

function resetFinalUI(){
  lockBadge.textContent = "üîí Locked ‚Äî beat all games";
  lockBadge.style.background = "rgba(0,0,0,.08)";
  lockBadge.style.border = "none";
  finalBody.textContent = "It‚Äôs locked until you finish the quest üíå";
  yesBtn.disabled = true;
  maybeBtn.disabled = true;
  maybeBtn.style.position = "relative";
  maybeBtn.style.left = "";
  maybeBtn.style.top = "";
  finalBox.style.display = "block";
  successBox.style.display = "none";
}

/* Ambient hearts */
function startAmbientHearts(){
  const hearts = ["‚ô°","‚ô•","üíó","üíñ"];
  setInterval(()=>{
    const h = document.createElement("div");
    h.className = "ambientHeart";
    h.textContent = hearts[Math.floor(Math.random()*hearts.length)];
    h.style.left = Math.random()*100 + "vw";
    h.style.fontSize = (10 + Math.random()*18) + "px";
    h.style.animationDuration = (7 + Math.random()*6) + "s";
    h.style.opacity = (0.10 + Math.random()*0.10).toFixed(2);
    document.body.appendChild(h);
    h.addEventListener("animationend", ()=>h.remove());
  }, 650);
}

/* =========================
   INIT
========================= */
buildCrossword();
buildQuiz();
setCatchHUD();
resetPuzzle();
startAmbientHearts();
goToStage(0);
</script>
</body>
</html